
<div class="dashboard-container text-center">

  <!-- mj_good : on récupère les bonnes réponses du maître du jeu... -->
  <% mj_good = @game.user.answers.where(status:true) %>
  <!-- mj_game_good : ... pour la partie en cours -->
  <% mj_game_good = mj_good.where(game_id:@game.id) %>
  <!-- total -->
  <% total_mj = 0 %>

  <% mj_game_good.each do |answer| %>
    <% total_mj += answer.score %>
  <% end %>

  <% total_player2 = 0 %>

  <% if @game.participants[0]%>
    <% player2_good = @game.participants[0].answers.where(status:true) %>
    <% player2_game_good = player2_good.where(game_id:@game.id) %>
    <% player2_game_good.each do |answer| %>
      <% total_player2 += answer.score %>
    <% end %>
  <% end %>

  <% if total_mj >= total_player2 %>
    <i class="fas fa-crown fa-4x"></i>
    <br>
    <span class="particletext confetti"> <%= @game.user.pseudo %></span>
    <p><%= total_mj %> points</p>

  <% else %> <%# elsif  @game.participants[0] %>
    <i class="fas fa-crown fa-4x"></i>
    <br>

    <span class="particletext confetti"> <%= @game.participants[0].pseudo %></span>
    <p><%= total_player2 %> points</p>
  <% end %>
</div>

    <!-- <div class="album-photo" style="background-image: url(<%#= result[0].album.images[0]["url"] %>)" >
    </div> -->

<!-- ---------------- -->

<div class="mx-2" >
  <% RSpotify.authenticate(ENV["SPOTIFY_CLIENT_ID"], ENV["SPOTIFY_CLIENT_SECRET"]) %>
  <% @game.playlist.tracks.each do |track| %>
    <% result = RSpotify::Track.search("#{track.title}") %>
    <div class="card-song">
      <img src="<%= result[0].album.images[0]["url"] %>"/>
    <div class="card-song-infos">
      <h2><%= track.title %></h2>
      <p><%= track.artist %></p>
    </div>
    <div class="result text-right">
      <p><%#= User.last.pseudo %></p>
      <p class="points">
        <!-- AFFICHAGE DES SCORES (LA HAUT C'EST LE CALCUL DU SCORE TOTAL) -->
        <% guess_track = track.answers.where(status:true) %>
        <% game_guess_track = guess_track.where(game_id:@game.id) %>
        <% game_guess_track.each do |answer| %>
          <div class="user-result <%= answer.user == current_user ? "green" : ""%>" data-user="<%= answer.user.id  %>">
            <% if answer.user.pseudo == "Ghost" %>
              <p> - </p>
            <% else %>
              <p><%= answer.user.pseudo %> </p>
                <%= answer.score %>
            <% end %>
          </div>
        <% end %> <!-- fin de |answer| do -->
      </p>
      </div>
    <% link = result[0].album.external_urls["spotify"] %>
    <%= link_to "#{link}", target: :_blank do %>
      <i class="fab fa-spotify spotify"></i>
    <% end %>
   </div>
  <% end %>
</div>

<!-- bouton rejouer -->
<div class="replay">
  <div class="text-center mt-5">
    <% @game = Game.new(user: current_user) %>
    <%= simple_form_for @game do |f| %>
      <%= f.submit "Rejouer", class: "btn-home" %>
    <% end %>
  </div>
</div>


